trigger:
  branches:
    include:
    - main
    - dev
  paths:
    exclude:
    - .gitignore.txt
    - README.md
    - LICENSE
    - azure-pipelines-windows.yml
    - azure-pipelines-macos.yml
    - .github/*

pr:
    - dev

pool:
  vmImage: ubuntu-latest

variables:
- name: buildConfiguration
  value: Release
- name: disable.coverage.autogenerate
  value: true
- group: shared-variables

steps:
- task: UseDotNet@2
  displayName: Install .NET Core 8.0 SDK
  inputs:
    packageType: sdk
    version: 8.0.x

- task: DotNetCoreCLI@2
  inputs:
    command: build
    projects: AudioWorks/AudioWorks.sln
    arguments: --configuration $(buildConfiguration)
  displayName: Build $(buildConfiguration) configuration

- script: |
    sudo apt-get install --yes libflac8 libmp3lame0 libopus0 libebur128-1 libvorbisenc2
  displayName: Download and install prerequisites

- task: DotNetCoreCLI@2
  inputs:
    command: test
    projects: AudioWorks/tests/AudioWorks.Common.Tests/AudioWorks.Common.Tests.csproj
    publishTestResults: true
    testRunTitle: AudioWorks.Common on .NET Core 8.0
    arguments: --framework net8.0 --configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Exclude=[AudioWorks.*.Tests]*,[AudioWorks.TestUtilities]*
  displayName: Test AudioWorks.Common on .NET 8.0

- task: DotNetCoreCLI@2
  inputs:
    command: test
    projects: AudioWorks/tests/AudioWorks.Extensibility.Tests/AudioWorks.Extensibility.Tests.csproj
    publishTestResults: true
    testRunTitle: AudioWorks.Extensibility on .NET 8.0
    arguments: --framework net8.0 --configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Exclude=[AudioWorks.*.Tests]*,[AudioWorks.TestUtilities]*
  displayName: Test AudioWorks.Extensibility on .NET 8.0

- task: DotNetCoreCLI@2
  inputs:
    command: test
    projects: AudioWorks/tests/AudioWorks.Api.Tests/AudioWorks.Api.Tests.csproj
    publishTestResults: true
    testRunTitle: AudioWorks.Api on .NET 8.0
    arguments: --framework net8.0 --configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Exclude=[AudioWorks.*.Tests]*,[AudioWorks.TestUtilities]*
  displayName: Test AudioWorks.Api on .NET 8.0

- task: DotNetCoreCLI@2
  inputs:
    command: test
    projects: AudioWorks/tests/AudioWorks.Commands.Tests/AudioWorks.Commands.Tests.csproj
    publishTestResults: true
    testRunTitle: AudioWorks.Commands on .NET 8.0
    arguments: --framework net8.0 --configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Exclude=[AudioWorks.*.Tests]*,[AudioWorks.TestUtilities]* DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.IncludeDirectory=$(Build.SourcesDirectory)/AudioWorks/tests/AudioWorks.Commands.Tests/bin/$(buildConfiguration)/net8.0/AudioWorks.Commands/net8.0
  displayName: Test AudioWorks.Commands on .NET 8.0

- task: reportgenerator@5
  inputs:
    reports: $(Agent.TempDirectory)/*/coverage.cobertura.xml
    targetdir: reports/coverage
    reporttypes: HtmlInline_AzurePipelines;Cobertura;Badges
    publishCodeCoverageResults: true
  displayName: Generate code coverage report

- task: PublishBuildArtifacts@1
  displayName: Publish artifacts